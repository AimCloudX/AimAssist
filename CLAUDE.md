# AimAssistリファクタリング計画

AimAssistのリファクタリング計画と進捗状況を記録するドキュメントです。

## リファクタリングの目的

- コードの可読性・保守性の向上
- アーキテクチャの改善と明確化
- 依存関係の適切な管理
- テスト容易性の向上
- パフォーマンスの最適化

## アーキテクチャの再構築

### クリーンアーキテクチャの導入

```
AimAssist/
├── Infrastructure/ (インフラストラクチャ層)
│   ├── Persistence/ (データ永続化)
│   ├── ExternalServices/ (外部サービス)
│   └── UI/ (ユーザーインターフェース)
├── Application/ (アプリケーション層)
│   ├── Services/ (サービス実装)
│   ├── Commands/ (コマンドハンドラー)
│   └── ViewModels/ (ビューモデル)
├── Domain/ (ドメイン層)
│   ├── Models/ (ドメインモデル)
│   ├── Services/ (ドメインサービス)
│   └── Interfaces/ (リポジトリやサービスのインターフェース)
└── Plugins/ (プラグイン拡張)
```

### 依存性の逆転の適用

- 上位モジュールを抽象化に依存させる
- 具象クラスへの直接依存を排除

## コード品質の改善

### 命名規則の統一

- 誤字の修正 (例: `UnitsService.Instnace` → `UnitsService.Instance`)
- ハードコードされた値の定数化
- 一貫した命名パターンの適用

### 例外処理の改善

- 適切なログ記録メカニズムの導入
- エラー回復処理の実装
- UIスレッドでの例外ハンドリングの強化

### コメントの改善と文書化

- XMLドキュメントコメントの追加
- 複雑なロジックへの説明コメント
- 公開APIドキュメントの充実

## パフォーマンスの最適化

### 非同期処理の改善

- `async/await`パターンの適切な使用
- `async void`の排除（テスト容易性向上）
- UIスレッドのブロッキング防止

### リソース管理の改善

- `IDisposable`の適切な実装
- `using`ステートメントの徹底
- メモリリークの防止

## テストの導入

### 単体テストの追加

- xUnit/NUnit/MSTestの導入
- 重要なビジネスロジックのテスト作成
- 境界条件のテスト

### モックフレームワークの導入

- Moq/NSubstituteの導入
- 依存関係のモック化
- テスト環境の構築

## プラグインシステムの改善

### プラグインローダーの強化

- エラー処理の改善
- プラグインのライフサイクル管理
- ロギングの強化

### プラグインのバージョン管理

- バージョン情報の追加
- 互換性チェックの実装
- プラグインメタデータの拡充

## ユーザーインターフェースの改善

### MVVMパターンの徹底

- ViewModel層とModel層の明確な分離
- コマンドパターンの一貫した使用
- データバインディングの適切な利用

### リソースとスタイルの整理

- アプリケーション全体のスタイルの統一
- リソースディクショナリの整理
- テーマ対応の改善

## 依存性注入コンテナの導入

- Microsoft.Extensions.DependencyInjection/Autofacの導入
- サービスの登録と解決
- コンストラクタインジェクションの実装

## 設定管理の改善

- 設定管理の一元化
- 型安全な設定クラスの導入
- 設定変更の通知メカニズム

## 国際化対応の改善

- リソースファイルの活用
- 文字列のハードコード排除
- 多言語対応の基盤整備

## リファクタリング実施計画

1. **準備フェーズ** 
   - [x] コードベースの詳細分析
   - [x] 基本テスト環境構築
   - [ ] テスト戦略策定
   - [ ] 優先順位付け

2. **基盤的リファクタリング**
   - [x] 依存性注入コンテナ導入
   - [x] インターフェース抽出
   - [x] ロギングフレームワーク導入
   - [x] エラーハンドリング改善

3. **命名と一貫性改善**
   - [ ] コードベース全体のレビュー
   - [ ] 命名規則のドキュメント作成
   - [ ] 命名の不一致修正
   - [ ] コーディング規約の適用

4. **構造的リファクタリング**
   - [ ] アーキテクチャ再構築
   - [ ] MVVMパターン適用
   - [x] 設定管理改善
   - [ ] プロジェクト構造の整理

5. **機能別リファクタリング**
   - [x] プラグインシステムのDI対応
   - [ ] プラグインライフサイクル管理
   - [ ] UI改善とMVVMパターン徹底
   - [ ] 国際化対応

6. **最適化**
   - [ ] パフォーマンス最適化
   - [ ] メモリ使用量最適化
   - [ ] UnitViewModel.csの改善
   - [ ] 非同期処理の最適化

7. **テストと品質保証**
   - [x] 基本的な単体テスト追加
   - [ ] テストカバレッジ拡大
   - [ ] 統合テスト追加
   - [ ] 手動テスト実施

## 進捗状況

| タスク | 状態 | 担当者 | 完了日 |
|-------|------|-------|-------|
| コードベース分析 | 完了 | - | 2025-04-24 |
| 依存性注入導入 | 完了 | - | 2025-04-25 |
| インターフェース抽出 | 完了 | - | 2025-04-25 |
| 設定管理改善 | 完了 | - | 2025-04-25 |
| テスト環境構築 | 進行中 | - | - |
| PluginsServiceのDI対応 | 完了 | - | 2025-04-25 |
| ClipboardPluginのDI対応 | 完了 | - | 2025-04-25 |
| 命名の一貫性改善 | 進行中 | - | - |
| SystemTrayRegisterのDI対応 | 完了 | - | 2025-04-25 |
| WindowHandleServiceのDI対応 | 完了 | - | 2025-04-25 |
| PickerServiceのDI対応 | 完了 | - | 2025-04-25 |
| CheatSheetControllerのDI対応 | 完了 | - | 2025-04-25 |
| AppCommandsのDI対応修正 | 完了 | - | 2025-04-25 |
| エラーハンドリング改善 | 完了 | - | 2025-04-25 |
| コンパイルエラーの修正 | 完了 | - | 2025-04-25 |
| 実行時エラーの修正 | 完了 | - | 2025-04-25 |
| ログ機能の実装 | 完了 | - | 2025-04-25 |
| プロジェクト構造のクリーンアーキテクチャ適用 | 未着手 | - | - |
| UnitViewModel.csの参照とキャッシュの改善 | 未着手 | - | - |

## 現在の課題

- UnitViewModel.csの参照を確認し、キャッシュの実装を改善する必要があります
- ~~サービスクラスのエラーハンドリングをさらに改善し、適切なログ記録メカニズムを実装する~~
- アプリケーション全体のアーキテクチャをクリーンアーキテクチャに沿って再構築する
- 命名の一貫性を確保するためのコード分析と修正を行う
  - メソッド名の綴りミスを修正（例：GetConterters → GetConverters）
  - 一貫した命名規則のドキュメント作成
- インターフェース修正時にメソッド名の変更が必要な場合は、全ての参照箇所の更新を忘れないようにする（例：SetForegroundWindow → ActivateWindow）
- インターフェースへの切り替え時には、依存関係を持つすべてのクラスも同様に更新する必要がある（例：AppCommandsクラスのコンストラクタ）
- テスト環境のさらなる強化と単体テスト・統合テストの追加
- MVVMパターンの完全適用（特にUIコンポーネント）
- プラグインシステムの機能強化（ライフサイクル管理、エラー処理、バージョン管理）

## 次のステップ

1. ✓ 残りのサービスクラスに対してインターフェースを抽出し、DIに対応させる
2. ✓ AppCommandsクラスをDIに完全対応させる
3. ✓ ユニットテストプロジェクトの追加
   - ✓ プロジェクト作成
   - ✓ DIコンテナのテスト
   - ✓ サービスの単体テスト
   - ✗ 統合テストの追加
4. ✓ SystemTrayRegisterをDIパターンに対応させる
5. エラーハンドリング機能の強化
   - ✓ 各種サービスのエラーハンドリング改善
   - ✓ 例外処理の適切な実装
   - ✗ ユーザーへの適切なエラー表示機能
   - ✗ エラーログ機能の拡充
6. 命名の一貫性改善
   - ✗ 命名の一貫性確保（例: GetConverters vs GetConterters）
   - ✗ 命名規則のドキュメント作成
   - ✗ コードベース全体のレビューと修正
7. UnitViewModel.csの改善
   - ✗ キャッシュ実装の見直し
   - ✗ 参照関係の整理
   - ✗ パフォーマンス最適化
8. クリーンアーキテクチャの適用
   - ✗ ドメイン層の整理（Models, Interfaces, Services）
   - ✗ アプリケーション層の整理（ViewModels, Commands, Services）
   - ✗ インフラストラクチャ層の整理（UI, Persistence, ExternalServices）
   - ✗ プロジェクト構造の再編成
9. MVVMパターンの強化
   - ✗ ViewModelとViewの明確な分離
   - ✗ コマンドパターンの一貫した使用
   - ✗ データバインディングの最適化
10. プラグインシステムの強化
    - ✓ PluginsServiceをDIパターンに対応
    - ✗ プラグインのライフサイクル管理
    - ✗ エラーハンドリングの改善
    - ✗ バージョン管理の実装
<!-- 11. 国際化対応
    - ✗ リソースファイルの整備
    - ✗ 文字列のハードコード排除
    - ✗ 多言語対応の基盤整備 -->
